# План: игровые функции и логика Fabricat (точка зрения игрока)

## Общее представление
- [ ] Цель партии: выжить без банкротства и накопить наибольший капитал к завершению раундов или остаться единственным игроком.
- [ ] Сервер выступает арбитром правил, биржей и источником экономических параметров.
- [ ] Игра поддерживает 2–4 игроков; при менее чем двух начало партии невозможно.

## Подготовка и лобби
- [ ] Регистрация игрока: выбор ника, аватара, присоединение по коду комнаты.
- [ ] Создание сессии: владелец задаёт параметры старта (капитал, ресурсы, заводы, экономические коэффициенты, длительность партии).
- [ ] Отображение списка подключённых игроков, таймера готовности, статуса доступных мест.
- [ ] Бросок `1d6` для определения старшинства перед первым месяцем с reroll для равных значений; анимация броска в UI.
- [ ] Возможность выгнать игрока из лобби (по необходимости правил) и обновить код приглашения.

## Стартовые настройки игрока
- [ ] Получение стартового капитала (по умолчанию $10 000).
- [ ] Инициализация ресурсов: 2 RM и 2 FG, 2 базовых завода (если не изменено настройками лобби).
- [ ] Отображение финансового резюме: наличные, капитал по оценке активов, долговая нагрузка.

## Игровой раунд (месяц)
### 1. Фаза расходов
- [ ] Автоматическое списание ежемесячных затрат на склады (RM/FG) и заводы (basic/automated).
- [ ] Проверка способности оплатить обязательные расходы; при невозможности — немедленное банкротство.

### 2. Публикация рынка
- [ ] Биржа объявляет объёмы и ценовые коридоры на покупку RM и продажу FG.
- [ ] Интерфейс показывает игроку новые значения для принятия решений следующей фазой.

### 3. Покупка сырья (RM)
- [ ] Игрок формирует скрытую заявку: количество и цена в пределах коридора месяца.
- [ ] Обеспечение лимитов: цена в коридоре, количество неотрицательное, наличие свободного складского места.
- [ ] Одновременное раскрытие ставок и распределение по убыванию цены, тай-брейк по старшинству.
- [ ] Обновление складских остатков и списание средств после распределения.

### 4. Производство
- [ ] Игрок выбирает заводы и объём переработки: basic (1 RM), automated (до 2 RM).
- [ ] Проверка доступности RM, свободной мощности и наличия средств на запуск (2 000 / 3 000 $).
- [ ] Списание стоимости запуска и перевод RM → FG; обновление складов.
- [ ] Учёт статуса заводов в апгрейде: работают как basic до завершения работ.

### 5. Продажа готовой продукции (FG)
- [ ] Формирование скрытой заявки: количество, цена ≤ потолок месяца.
- [ ] Одновременное раскрытие заявок и покупка биржей по возрастанию цены, тай-брейк по старшинству.
- [ ] Зачисление средств и уменьшение склада FG по результатам сделки.

### 6. Кредиты
- [ ] Автоматическое начисление процентов (1%/мес.) и списание плановых платежей.
- [ ] Возможность взять новый кредит (5k или 10k $) при соблюдении лимитов: долг ≤ 1/2 гарантированного капитала, наличие залога (заводы).
- [ ] Отказ от досрочного погашения (правило запрещает).
- [ ] Отображение графика платежей и активных долгов.

### 7. Строительство и автоматизация
- [ ] Подача заявок на строительство базового/автоматизированного завода или апгрейд.
- [ ] Проверка лимита заводов (активные + строящиеся ≤ 6) и наличия средств.
- [ ] Оплата 50% сейчас и 50% за месяц до ввода, учёт длительности (5/7/9 месяцев).
- [ ] Обновление таймлайна строительства и статусов производственных мощностей.

### 8. Завершение месяца
- [ ] Проверка банкротств: невозможность оплатить обязательства ⇒ исключение, аннулирование будущих заявок.
- [ ] Ротация таблицы старшинства циклически; журналировать фазы, где решались тай-брейки.
- [ ] Подготовка отчёта месяца: баланс, складские остатки, производство, сделки, кредиты, стройки.

## Механики приоритетов и тай-брейков
- [ ] Таблица старшинства хранится и обновляется каждый месяц; используется в фазах торгов и при равенстве значений.
- [ ] Журнал решений фиксирует, в каком месяце и по какому правилу был разрешён каждый тай-брейк.

## Управление рисками и ограничения
- [ ] Контроль времени на действие: 60 секунд на фазу; просрочка = автоматический пропуск.
- [ ] Запрет на отрицательный баланс наличных при оплате расходов, производства или строительства.
- [ ] Отсутствие прямых переводов средств между игроками.
- [ ] Валидация заявок против текущих рыночных коридоров и внутренние проверки на консистентность данных.

## Подсчёт капитала и конец игры
- [ ] Расчёт капитала: наличные + оценка активов (заводы по цене строительства, RM по минимальной цене месяца, FG по максимальной цене) − долги − незакрытые платежи.
- [ ] Условия завершения: достижение заданного числа месяцев или остаётся один непавший игрок.
- [ ] Определение победителя по величине капитала, публикация таблицы лидеров.

## Аналитика и отчётность для игрока
- [ ] Доступ к журналу хода: отчёт по фазам, решением системы и действиям.
- [ ] Личный и публичный дашборд: капитал, наличные, долги, объёмы RM/FG, статусы заводов, активные кредиты, позиция в старшинстве.
- [ ] История по последним 10 играм: средний/лучший капитал, победы/поражения, винрейт, максимальная и средняя длительность матчей.
- [ ] Просмотр аналитики других игроков (как разрешено правилами) для стратегического сравнения.

## Требования к интерфейсу
- [ ] Игровой экран с квадрантами игроков: аватар, ник, капитал, наличные, долги, склады, заводы, кредиты, индикатор старшинства.
- [ ] Панель действий фаз с возможностью редактировать заявки до отправки или тайм-аута.
- [ ] Экран результатов месяца с лидербордом и модальным окном анализа тай-брейков.

